---
import DarkTechnoHero from '../assets/dark-techno-hero.svg?raw';

const allLogosObj = import.meta.glob<{ default: ImageMetadata }>([
    '/src/assets/skills/*.svg',
    '!/src/assets/skills/icon-*.svg',
    '!/src/assets/skills/front-Astro.svg',
    '!/src/assets/skills/back-Express.svg',
    '!/src/assets/skills/front-htmx.svg',
]);
const logoPaths = Object.keys(allLogosObj);
const shuffledPaths = logoPaths.sort(() => Math.random() - 0.5);

const tracks = [
    // Top Left Loop
    { id: 'track-1', d: 'M100 400 L100 100 L300 100 L350 150 L450 150' },
    // Top Right Loop
    { id: 'track-2', d: 'M700 400 L700 100 L500 100 L450 150' },
    // Bottom Center Loop
    { id: 'track-3', d: 'M250 650 L325 750 L475 750 L550 650' },
    // Center Outward Right
    { id: 'track-4', d: 'M400 350 L450 350 L550 450 L550 650' },
    // Center Outward Left
    { id: 'track-5', d: 'M400 350 L350 350 L250 450 L250 650' },
    // Side Inward Left
    { id: 'track-6', d: 'M100 400 L200 400 L250 450' },
    // Side Inward Right
    { id: 'track-7', d: 'M700 400 L600 400 L550 450' },
    // Bottom Outward Left
    { id: 'track-8', d: 'M100 550 L100 650 L250 650' },
    // Bottom Outward Right
    { id: 'track-9', d: 'M700 600 L700 650 L550 650' },
    // Long Vertical Left
    { id: 'track-10', d: 'M100 100 L100 650' },
    // Long Vertical Right
    { id: 'track-11', d: 'M700 100 L700 650' },
];

const MAX_ICONS = 15; // Limit number of icons to prevent clutter
const activePaths = shuffledPaths.slice(0, MAX_ICONS);

async function getLogoSrc(path: string) {
    const mod = await allLogosObj[path]();
    return mod.default;
}
---

<div class="relative w-full h-full flex items-center justify-center">
    <div class="relative h-full aspect-square max-w-4xl">
        <!-- Layer 1: Raw SVG background -->
        <div
            class="absolute inset-0 z-0 opacity-60 [&>svg]:w-full [&>svg]:h-full [&>svg]:stroke-cyan-500/50"
            set:html={DarkTechnoHero}
        />

        <!-- Layer 2: Moving Skill Icons (SVG Overlay) -->
        <svg
            class="absolute inset-0 z-10 w-full h-full pointer-events-none"
            viewBox="0 0 800 800"
            preserveAspectRatio="xMidYMid slice"
        >
            <defs>
                {tracks.map((track) => <path id={track.id} d={track.d} fill="none" />)}
            </defs>

            {
                activePaths.map(async (logoPath, index) => {
                    const src = await getLogoSrc(logoPath);
                    const trackIndex = index % tracks.length;
                    const track = tracks[trackIndex];

                    // Slower movement: duration between 25s and 45s
                    const duration = 10 + Math.random() * 10;

                    // Greater separation: start time offset up to -40s to spread them out
                    const beginTime = -(Math.random() * 40);

                    return (
                        <g>
                            {/* Glow effect behind the icon */}
                            <circle r="25" fill="rgba(6, 182, 212, 0.1)" filter="blur(2px)">
                                <animateMotion
                                    dur={`${duration}s`}
                                    repeatCount="indefinite"
                                    rotate="auto"
                                    begin={`${beginTime}s`}
                                >
                                    <mpath href={`#${track.id}`} />
                                </animateMotion>
                            </circle>

                            {/* The Icon */}
                            <image href={src.src} width="40" height="40" x="-20" y="-20" class="opacity-90">
                                <animateMotion
                                    dur={`${duration}s`}
                                    repeatCount="indefinite"
                                    rotate="0"
                                    begin={`${beginTime}s`}
                                    keyPoints="0;1"
                                    keyTimes="0;1"
                                    calcMode="linear"
                                >
                                    <mpath href={`#${track.id}`} />
                                </animateMotion>
                            </image>
                        </g>
                    );
                })
            }
        </svg>
    </div>
</div>

<style>
    /* Additional animations if needed */
    .animate-pulse-slow {
        animation: pulse 6s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
</style>

<style is:global>
    /* SVG Styles */
    .circuit-path {
        stroke: #475569;
        stroke-width: 2;
        fill: none;
    }

    .active-stream {
        stroke: url(#stream-grad);
        stroke-width: 3;
        stroke-linecap: round;
        fill: none;
        stroke-dasharray: 50, 200;
        filter: url(#neon-glow);
        opacity: 0.8;
    }

    /* Data flow animation (The Pipeline) */
    @keyframes flow {
        to {
            stroke-dashoffset: -250;
        }
    }

    /* Node pulsing animation (The Network Pulse) */
    @keyframes pulseNode {
        0%,
        100% {
            transform: scale(1);
            filter: drop-shadow(0 0 3px rgba(6, 182, 212, 0.4));
        }
        50% {
            transform: scale(1.15);
            filter: drop-shadow(0 0 7px rgba(217, 70, 239, 0.7));
        }
    }

    .node-pulse {
        transform-box: fill-box;
        transform-origin: center;
        animation: pulseNode 3s ease-in-out infinite;
    }

    /* Fast-flowing streams */
    #stream-1,
    #stream-5 {
        animation: flow 1.5s linear infinite;
    }

    /* Slower streams */
    #stream-2,
    #stream-3,
    #stream-12 {
        animation: flow 3s linear infinite;
    }

    /* Reversed stream (can indicate upload or a different process) */
    #stream-4,
    #stream-13 {
        animation: flow 3s linear infinite reverse;
        stroke: #10b981; /* Give one stream a different color for variety */
    }

    #stream-14 {
        animation: flow 2s linear infinite;
    }

    /* New Side Streams */
    #stream-6,
    #stream-7 {
        animation: flow 4s linear infinite;
    }

    #stream-8,
    #stream-9,
    #stream-10,
    #stream-11,
    #stream-15,
    #stream-16,
    #stream-17,
    #stream-18 {
        animation: flow 3s linear infinite;
    }
</style>
