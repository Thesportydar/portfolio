---
import DarkTechnoHero from '../assets/dark-techno-hero.svg?raw';
import { Image } from 'astro:assets';

// 1. Import all skill logos
const allLogosObj = import.meta.glob<{ default: ImageMetadata }>('/src/assets/skills/*.svg');
const logoPaths = Object.keys(allLogosObj);
// Optional: Shuffle so they don't always appear in the same slots
const shuffledPaths = logoPaths.sort(() => Math.random() - 0.5);

// 2. Define coordinates for the logos based on the 800x800 SVG viewBox
// These points are aligned with the visual "pipeline" in the background SVG.
const pipelineSlots = [
    // Top Horizontal Lines
    { top: '12.5%', left: '22.5%', className: 'animate-float-h' },
    { top: '12.5%', left: '72.5%', className: 'animate-float-h' },

    // Mid Vertical Lines
    { top: '31.25%', left: '43.75%', className: 'animate-float-v' },
    { top: '31.25%', left: '56.25%', className: 'animate-float-v' },

    // Side Vertical Lines (Upper)
    { top: '31.25%', left: '12.5%', className: 'animate-float-v' },
    { top: '31.25%', left: '87.5%', className: 'animate-float-v' },

    // Side Connectors (Horizontal)
    { top: '50%', left: '20%', className: 'animate-float-h' },
    { top: '50%', left: '80%', className: 'animate-float-h' },

    // Lower Vertical Lines
    { top: '68.75%', left: '31.25%', className: 'animate-float-v' },
    { top: '68.75%', left: '68.75%', className: 'animate-float-v' },

    // Side Vertical Lines (Lower)
    { top: '68.75%', left: '12.5%', className: 'animate-float-v' },
    { top: '68.75%', left: '87.5%', className: 'animate-float-v' },
];

// Utility to dynamically import the logo's src
async function getLogoSrc(path: string) {
    const mod = await allLogosObj[path]();
    return mod.default;
}
---

<div class="relative w-full h-full flex items-center justify-center">
    <div class="relative h-full aspect-square max-w-4xl">
        <!-- Layer 1: Raw SVG background for precise alignment -->
        <!-- Added fill-white/opacity adjustments to ensure visibility on black bg -->
        <div
            class="absolute inset-0 z-0 opacity-60 [&>svg]:w-full [&>svg]:h-full [&>svg]:stroke-cyan-500/50"
            set:html={DarkTechnoHero}
        />

        <!-- Layer 2: Floating skill logos -->
        <div class="absolute inset-0 z-10 pointer-events-none w-full h-full">
            {
                pipelineSlots.map(async (slot, index) => {
                    // Cycle through logos if there are more slots than logos
                    const logoPath = shuffledPaths[index % shuffledPaths.length];
                    const src = await getLogoSrc(logoPath);

                    return (
                        <div
                            class:list={['absolute flex items-center justify-center', slot.className]}
                            style={{
                                top: slot.top,
                                left: slot.left,
                                width: '3rem',
                                height: '3rem',
                                transform: 'translate(-50%, -50%)', // Initial centering
                            }}
                        >
                            <div class="absolute inset-0 bg-cyan-500/10 rounded-full blur-sm" />
                            <Image
                                src={src}
                                alt="Technology icon"
                                class="w-8 h-8 opacity-90 drop-shadow-[0_0_5px_rgba(6,182,212,0.8)]"
                            />
                        </div>
                    );
                })
            }
        </div>
    </div>
</div>

<style>
    /* Subtle floating animations */
    @keyframes float-h {
        0%,
        100% {
            transform: translate(-50%, -50%) translateX(0);
        }
        50% {
            transform: translate(-50%, -50%) translateX(15px);
        }
    }

    @keyframes float-v {
        0%,
        100% {
            transform: translate(-50%, -50%) translateY(0);
        }
        50% {
            transform: translate(-50%, -50%) translateY(15px);
        }
    }

    /* Assign animations with longer durations for a calmer effect */
    .animate-float-h {
        animation: float-h 4s ease-in-out infinite;
    }
    .animate-float-v {
        animation: float-v 5s ease-in-out infinite;
    }
    .animate-pulse-slow {
        animation: pulse 6s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
</style>

<style is:global>
    /* SVG Styles */
    .circuit-path {
        stroke: #475569;
        stroke-width: 2;
        fill: none;
    }

    .active-stream {
        stroke: url(#stream-grad);
        stroke-width: 3;
        stroke-linecap: round;
        fill: none;
        stroke-dasharray: 50, 200;
        filter: url(#neon-glow);
        opacity: 0.8;
    }

    /* Data flow animation (The Pipeline) */
    @keyframes flow {
        to {
            stroke-dashoffset: -250;
        }
    }

    /* Node pulsing animation (The Network Pulse) */
    @keyframes pulseNode {
        0%,
        100% {
            transform: scale(1);
            filter: drop-shadow(0 0 3px rgba(6, 182, 212, 0.4));
        }
        50% {
            transform: scale(1.15);
            filter: drop-shadow(0 0 7px rgba(217, 70, 239, 0.7));
        }
    }

    /* ... */

    .node-pulse {
        /* 1. Define que la caja de referencia es el propio elemento, no el SVG entero */
        transform-box: fill-box;

        /* 2. Pon el pivote en el centro de esa caja */
        transform-origin: center;

        /* Tu animaci√≥n existente */
        animation: pulseNode 3s ease-in-out infinite;
    }

    /* Assign animations to specific SVG elements by ID */
    /* Note: These IDs must exist in the DarkTechnoHero SVG */

    /* Fast-flowing streams */
    #stream-1,
    #stream-5 {
        animation: flow 1.5s linear infinite;
    }

    /* Slower streams */
    #stream-2,
    #stream-3,
    #stream-12 {
        animation: flow 3s linear infinite;
    }

    /* Reversed stream (can indicate upload or a different process) */
    #stream-4,
    #stream-13 {
        animation: flow 3s linear infinite reverse;
        stroke: #10b981; /* Give one stream a different color for variety */
    }

    #stream-14 {
        animation: flow 2s linear infinite;
    }

    /* New Side Streams */
    #stream-6,
    #stream-7 {
        animation: flow 4s linear infinite;
    }

    #stream-8,
    #stream-9,
    #stream-10,
    #stream-11,
    #stream-15,
    #stream-16,
    #stream-17,
    #stream-18 {
        animation: flow 3s linear infinite;
    }
</style>
